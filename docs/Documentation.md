# 2025 OOPL Final Report

## 組別資訊

組別：49

組員：楊君威，黃音慈

復刻遊戲：`Castlevania NES`

## 專案簡介

### 1. 遊戲簡介  
本專案為復刻經典紅白機動作遊戲《惡魔城（Castlevania）》的版本。重現其前三個經典關卡，包含角色控制、掉落道具、敵人、Boss戰、關卡機制與音效特效等，打造具有懷舊風格的挑戰性平台遊戲。

### 2. 組別分工  
本專案由兩位組員共同開發，採取協同設計與任務分工的方式完成。
在主要類別（如 `Character`、`Scene`、`Enemy`）部分，兩人共同討論與撰寫，確保整體邏輯與架構一致。

針對衍生類別，雖屬同一類型功能，但依項目分工實作，例如一人負責角色的跳躍，另一人負責蹲下；敵人如 `Zombie`、`Phantom` 等也依照類型拆分。

兩人皆參與整合、測試與除錯，確保遊戲完整穩定。

---

## 遊戲介紹

### 1. 遊戲規則  

玩家扮演吸血鬼獵人 `Simon Belmont`，使用鞭子與副武器對抗敵人並突破重重關卡。操作方式包括：

- `A`，`D`：左右移動
- `W`，`S`：上下樓梯
- `S`：蹲下
- `K`：跳
- `J`：鞭子攻擊
- `J`+`W`：使用副武器

### 2. 道具

因道具眾多，提供以下連結作爲參考，。我們只有實作前三關中會出現的道具。

[Loots](Loots.md)

### 3. Debug 模式

進入 Debug 模式後，遊戲時間暫停，角色不會受傷（若於 `STAGE2B` 掉入水中還是會死亡）。
當切換到不同關卡，角色的鞭子等級、副武器、關卡中的火把等皆會重置。

- `6` ： 切換一般模式與 Debug 模式
- `0`：換到 `Stage 00`
- `1`：換到 `Stage 01`
- `2`：換到 `Stage 02`
- `3`：換到 `Stage 03`

---

#### 關卡說明：

- **Stage 00 (Castle Entrance)**  
  - 敵人：無  
  - 簡單關卡，用於學習基本操作與遊戲機制  
  - 以移動為主，無敵人干擾

- **Stage 01 (Entrance Hall)**  
  - 敵人：`Zombie`、`Leopard`  
  - 作為正式進入的起點  
  - 著重於移動與基本攻擊

- **Stage 02 (Crypt)**  
  - 敵人：`Bat`、`Fishman`  
  - 引入場景變換與平台跳躍元素
  - 場景分為 `STAGE2A`、`STAGE2B` 
  - 考驗玩家的反應速度與操控節奏

- **Stage 03 (Phantom Bat)**  
  - 敵人：`Zombie`
  - Boss：`Phantom Bat`  
  - 場景空間狹小，敵人密集  
  - `Boss` 戰，引導玩家使用副武器和躲避敵人攻擊

### 2. 遊戲畫面  
<img src="images/title.png" alt="Title" width="500"/>

<img src="images/castle-entrance.png" alt="Castle Entrance" width="500"/>

<img src="images/entrance-hall.png" alt="Entrance Hall" width="500"/>

<img src="images/crypt.png" alt="Crypt" width="500"/>

<img src="images/boss.png" alt="Boss" width="500"/>

---

## 程式設計

### 1. 程式架構

**類別架構**

<img src="images/architecture.png" alt="Architecture" width="600"/>

**游戲流程**

<img src="images/flowchart.png" alt="Flowchart" width="600"/>

### 2. 程式技術

#### 1. 物件導向設計（OOP）

本專案廣泛運用物件導向的三大特性：**繼承、封裝、多型**，使各個模組更具擴充性與可維護性。

- **繼承與多型**：
  - `Enemy` 為敵人基底類別，`Zombie`、`Leopard`、`Bat`、`Fishman`、`PhantomBat` 等敵人類別皆繼承自 `Enemy`，並根據不同行為覆寫移動、攻擊、碰撞等函式。
  - `Loot` 為道具基底類別，`Bag`、`Chicken` 等道具、`Whip`、`Axe` 等副武器，皆繼承自 `Loot`，並依照功能實作取得效果（如補血、加分、升級武器等）。
  - `Scene` 為場景基底類別，`Title`、`Stage0 ~ Stage3`、`GG` 等皆繼承自 `Scene`，每個關卡/畫面擁有不同的初始化與顯示邏輯。
- **封裝**：
  - 每個類別的屬性與方法皆封裝在類別內，外部無法直接存取，確保數據安全性。
  - 使用 getter/setter 方法來控制屬性的存取與修改。
- **組合**：
  - `App` 組合了 `Scene`、`Menu`、`Character` 等物件，管理遊戲主流程。
  - `EnemiesManager` 管理所有敵人、敵人死亡後掉落的物件與敵人移動行為。

#### 2. 狀態機行動管理

- **角色**：  
  角色與敵人皆擁有明確的狀態（如 `idle`、`walk`、`jump`、`attack`、`hurt`、`dead`），並根據當前狀態切換對應的動畫與行為邏輯。

- **敵人**：
  - 敵人類別（如 `Leopard`、`Fishman`）皆實作了狀態機，根據當前狀態（如 `idle` `walk`、`attack`、`hurt`、`dead`、`spawn`）切換動畫與行為邏輯。
  - Boss `PhantomBat` 採用階段式狀態設計，包含 `idle`、`fly`、`dive` 等多段攻擊模式，透過狀態切換與時間控制調整戰鬥節奏。

#### 3. 碰撞偵測

- **AABB（Axis-Aligned Bounding Box）碰撞**：  
  所有物件（如角色、敵人、道具、火把、可破壞方塊）皆使用座標與尺寸進行 AABB 碰撞判斷，確認是否發生重疊。

- **事件觸發**：  
  根據碰撞結果，進行對應的遊戲事件處理，例如：
  - 角色受傷或死亡
  - 敵人被擊敗並掉落道具
  - 方塊被擊破後觸發掉落物或特效

#### 4. 事件與時間控制

- **SDL 計時系統**：  
  使用 `SDL_GetPerformanceCounter` 搭配自訂的 `Time::GetRunTimeMs()` 函數，精準控制以下遊戲邏輯中的時間相關行為：
  - 動畫播放速度  
  - 敵人行為間隔  
  - 道具出現與消失時間  

- **冷卻與延遲機制**：  
  遊戲中多處行為皆使用冷卻與延遲設計來維持節奏平衡，例如：
  - 敵人重生時間控制  
  - 道具自動消失時間  
  - Boss（如 `PhantomBat`）狀態切換延遲  

#### 5. 物理運算與數學應用

- **物理運動模擬（速度向量與目標追蹤）**：  
  在 `PhantomBat` 的飛行與俯衝邏輯中，透過計算當前位置與目標位置的距離，推導出速度向量，實現朝目標點的平滑移動。  
  所使用的公式如下：

  - 計算 X 軸速度：
    ```
    vel.x = (pos.x < target.x) ? speed : -speed;
    ```

  - 計算 Y 軸速度（斜率補償）：
    ```
    vel.y = |target.y - pos.y| / (|target.x - pos.x| / |vel.x|);
    vel.y *= (pos.y < target.y) ? 1 : -1;
    ```

  該設計確保 PhantomBat 能夠穩定地朝目標方向移動，不會瞬移或忽快忽慢。

- **三角函數（sin 函數）應用於俯衝攻擊**：  
  在 `Dive()` 中，PhantomBat 的俯衝運動使用正弦函數 `sin()` 產生自然的拋物線效果，模擬類似真實物理的攻擊軌跡。  
  使用的公式如下：

  - 計算俯衝過程中的 Y 軸速度：
    ```
    vel.y = -yDistance × sin(diveTime / tDive × π);
    ```

  其中：
  - `diveTime`：目前經過的時間（模擬進度）
  - `tDive`：俯衝總時間（隨機設定）
  - `yDistance`：從起點到俯衝最低點的距離

  此設計使俯衝過程在速度與視覺上都更流暢自然，並提高遊戲挑戰性與觀賞性。

- **視覺特效中的擺動應用**：  
  類似的 `sin()` 函數也應用於 `Bat`（蝙蝠）與 `Heart`（愛心道具）的移動軌跡，用來產生波浪型或擺動式的運動，使物件移動更具生命感與變化性。


## 結語

### 問題及解決方法
### 貢獻比例
- 楊君威（50%）
- 黃音慈（50%）

### 自我檢核表

| 項次 | 項目                                   | 完成 |
|------|---------------------------------------|-------|
| 1    | 這是範例                               |  ✅  |
| 2    | 完成專案權限改為 public                 |    |
| 3    | 具有 debug mode 的功能                 |  ✅  |
| 4    | 解決專案上所有 Memory Leak 的問題       |  ✅  |
| 5    | 報告中沒有任何錯字，以及沒有任何一項遺漏  |    |
| 6    | 報告至少保持基本的美感，人類可讀         |  ✅  |

### 收穫

透過本次專案，我們深入理解了物件導向設計的核心概念，並實際應用於遊戲開發中。學會了如何使用繼承、多型與封裝來組織程式碼，使其更具可讀性與可維護性。此外，透過實作碰撞偵測、狀態機與事件處理等技術，增強了我們對遊戲邏輯與物理運算的理解。

### 心得

本次專案讓我們體驗到遊戲開發的樂趣與挑戰，從設計遊戲機制到實作細節，每一步都充滿創意與技術挑戰。透過團隊合作，我們學會了如何分工協作，並在遇到問題時共同解決。最終完成的遊戲不僅重現了經典，也融入了我們的創意，感到非常滿足。

### 對於本課程的建議
沒有，謝謝老師及助教們
